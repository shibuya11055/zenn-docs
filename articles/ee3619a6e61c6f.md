---
title: "ã€TypeScriptã€‘discriminated unionã§narowwingã§ãã¦ã„ãªã‹ã£ãŸäº‹ä¾‹"
emoji: "ğŸ­"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["TypeScript"]
published: true
---

# narowwingã§ããªã„ï¼Ÿ
ç§ãŒé­é‡ã—ãŸã€Œãˆï¼Ÿã“ã‚Œãªã‚“ã§ãƒŠãƒ­ãƒ¼ã‚¤ãƒ³ã‚°ã§ãã¦ãªã„ã®ï¼Ÿã€ãªäº‹ä¾‹ã‚’ç´¹ä»‹ã—ã¾ã™ã€‚
## narrowing
`narowwing`ã¨ã¯æ¡ä»¶æ–‡ãªã©ã‚’åˆ©ç”¨ã—ã¦TSã®å‹ã‚’çµã‚Šã“ã‚€ã“ã¨ã‚’æŒ‡ã—ã¾ã™ã€‚
```ts
type NumType = number | null

const increment = (num: NumType) => {
  if (typeof num === 'number') {
    return num + 1 // ã“ã®ã¨ãnumã®å‹ã¯numberã§ã‚ã‚‹ã“ã¨ãŒç¢ºå®šã—ã¦ã„ã‚‹
  }
  return
}
```
## discriminated union
ã“ã¡ã‚‰ã¯ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­ã«**åˆ¤åˆ¥å¯èƒ½ãªãƒªãƒ†ãƒ©ãƒ«ã‚’æŒã¤ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£**ãŒå­˜åœ¨ã—ã¦ãŠã‚Šã€ã“ã‚ŒãŒå«ã¾ã‚Œã‚‹Unionå‹ã¯ãã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ã‚’åˆ¤åˆ¥ã§ãã‚‹ã¨ã„ã†ã‚‚ã®ã§ã™ã€‚
https://typescript-jp.gitbook.io/deep-dive/type-system/discriminated-unions

```ts
type UserA = {
  name: 'å¤ªéƒ',
  gender: string
}

type UserB = {
  name: 'æ¬¡éƒ',
  age: number
}

type User = UserA | UserB

const func = (user: User) => {
  if (user.name === 'å¤ªéƒ') {
    return user.gender // nameãŒå¤ªéƒãªã®ã§UserAã«çµã‚Šè¾¼ã¾ã‚Œã‚‹
  }
  return user.age // UserBã¨åˆ¤å®šã•ã‚Œã‚‹(ageã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹)
}
```

# æœ¬é¡Œ
ã§ã¯**ã§ãã¦ã„ãªã‹ã£ãŸãƒ‘ã‚¿ãƒ¼ãƒ³**ã‚’ã¿ã¦ã„ãã¾ã—ã‚‡ã†ã€‚
## å®Ÿã¯ãƒªãƒ†ãƒ©ãƒ«ã§ã¯ãªã„
ä¸‹è¨˜ã®ã‚ˆã†ãªå ´åˆã§ã™ã€‚
```ts
const userA = {
  name: 'å¤ªéƒ',
  gender: 'male',
}

const userB = {
  name: 'æ¬¡éƒ',
  age: 20,
}

type User = typeof userA | typeof userB

const func = (user: User) => {
  if (user.name === 'å¤ªéƒ') {
    return user.gender // Property 'gender' does not exist on type 'User'
  }
  return user.age // Property 'age' does not exist on type 'User'
}
```

ä¸€è¦‹å‰è¿°ã—ãŸã‚³ãƒ¼ãƒ‰ã¨åŒã˜ã«è¦‹ãˆã¾ã™ãŒã€ã“ã®å ´åˆAã¨Bã®å‹ã‚’çµã‚Šè¾¼ã‚€ã“ã¨ã¯ã§ãã¾ã›ã‚“ã€‚
ãã‚Œã¯`name`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å‹ãŒãƒªãƒ†ãƒ©ãƒ«ã§ã¯ãªã`string`ã ã‹ã‚‰ã§ã™ã€‚
```ts
// type UserA
type UserA = {
    name: 'å¤ªéƒ';
    gender: string;
}

// typeof userA
const userA: {
  name: string;
  gender: string;
}
```

`typeof objct`ã™ã‚‹ã¨æ¨è«–ã•ã‚Œã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®å‹ã¯ãƒ—ãƒªãƒŸãƒ†ã‚£ãƒ–ã«ãªã‚Šã¾ã™ã€‚
ãã®ãŸã‚`discriminated union`ã§ã¯ãªããªã‚Šã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®å‹ã‚’çµã‚Šè¾¼ã‚€ã“ã¨ãŒã§ããªã‹ã£ãŸã®ã§ã™ã€‚
ã€Œãã‚Šã‚ƒãã†ã ã€ã¨ãªã‚Šãã†ã§ã™ãŒã€ç§ã¯ã“ã‚Œã‚’è¦‹è½ã¨ã—ã¦ã„ã¾ã—ãŸã€‚

### 2022.10.22 è¿½è¨˜ / const assertion
[kazuwombat](https://zenn.dev/kazuwombat)ã•ã‚“ã‚ˆã‚Šã€`as const`ã‚’ç”¨ã„ãŸæ–¹æ³•ã‚’[ã‚³ãƒ¡ãƒ³ãƒˆ](https://zenn.dev/link/comments/496d10ffce7863)ã„ãŸã ãã¾ã—ãŸã€‚
ã“ã®æ–¹æ³•ãªã‚‰`typeof`ã‚’åˆ©ç”¨ã—ã¦ã‚‚ãƒªãƒ†ãƒ©ãƒ«å‹ãŒå›ºå®šã•ã‚Œã‚‹ãŸã‚ã€narowwingãŒåŠ¹ãã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚
å‹‰å¼·ã«ãªã‚Šã¾ã—ãŸã€‚kazuwombatã•ã‚“ã‚ã‚ŠãŒã¨ã†ã”ã–ã„ã¾ã™ï¼
```ts
const userA = {
  name: 'å¤ªéƒ',
  gender: 'male',
} as const

const userB = {
  name: 'æ¬¡éƒ',
  age: 20,
} as const

type User = typeof userA | typeof userB

const func = (user: User) => {
  if (user.name === 'å¤ªéƒ') {
    return user.gender
  }
  return user.age
}
```

## ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªãƒªãƒ†ãƒ©ãƒ«
### ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã¨ã‚¤ã‚³ãƒ¼ãƒ«
å†åº¦ãƒªãƒ†ãƒ©ãƒ«ã‚’æŒã¤Userå‹ã‚’å®šç¾©ã—ã¾ã™ã€‚
```ts
type User =
  | { name: 'å¤ªéƒ'; gender: string; }
  | { name: 'æ¬¡éƒ'; age: number; }
```
ã“ã®æ™‚`===`ã‚’åˆ©ç”¨ã™ã‚‹ã“ã¨ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’çµã‚Šè¾¼ã‚€ã“ã¨ã¯ã§ãã¾ã—ãŸã€‚
ã§ã¯æ¬¡ã®ã‚ˆã†ãªå ´åˆã¯ã©ã†ã§ã—ã‚‡ã†ã‹ã€‚
```ts
// nameãŒã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã«ãªã£ãŸ
type User =
  | { name?: 'å¤ªéƒ'; gender: string; }
  | { name?: 'æ¬¡éƒ'; age: number; }
```
åŒã˜ã‚ˆã†ã«é–¢æ•°ã‚’æ›¸ã„ã¦ã¿ã‚‹ã¨`age`ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“ã€‚
ãã‚Œã‚‚ãã®ã¯ãšã€å¤ªéƒã§çµã‚Šè¾¼ã‚“ã§ã‚‚`name`ã¯`æ¬¡éƒ`ã¨`undefined`ã®å¯èƒ½æ€§ã‚’æŒã£ã¦ã„ã¾ã™ã€‚
```ts
const func = (user: User) => {
  if (user.name === 'å¤ªéƒ') {
    return user.gender //ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹
  }
  return user.age // ã‚¢ã‚¯ã‚»ã‚¹ã§ããªã„
}
```
ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªå ´åˆã¯ãã‚Œãã‚Œæ¯”è¼ƒã™ã‚‹ã“ã¨ã§è§£æ±ºã—ã¾ã™ã€‚
```ts
const func = (user: User) => {
  if (user.name === 'å¤ªéƒ') {
    return user.gender
  }
  if (user.name === 'æ¬¡éƒ') {
    return user.age
  }
  return
}
```

### ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã¨ãƒãƒƒãƒˆã‚¤ã‚³ãƒ¼ãƒ«
å•é¡Œã¯ãƒãƒƒãƒˆã‚¤ã‚³ãƒ¼ãƒ«ã®å ´åˆã§ã™ã€‚
å…ˆã»ã©ã®é–¢æ•°ã§è¡Œã£ã¦ã„ãŸæ¯”è¼ƒã‚’ã‚¤ã‚³ãƒ¼ãƒ«ã§ã¯ãªããƒãƒƒãƒˆã‚¤ã‚³ãƒ¼ãƒ«ã§è¡Œã£ã¦ã¿ã¾ã—ã‚‡ã†ã€‚
ã‚‚ã¡ã‚ã‚“ã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ãªã®ã§å­˜åœ¨ã®åˆ¤å®šã‚‚ã¤ã‘ã¦ã‚ã’ã¾ã™ã€‚
```ts
const func = (user: User) => {
  if (!user.name) return
  if (user.name !== 'å¤ªéƒ') {
    user.name // (property) name?: "æ¬¡éƒ"
    return user.age // Property 'age' does not exist on type 'User'.
  }
  return user.gender
}
```

ã“ã®å ´åˆã€`age`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã¯å‹ã‚¨ãƒ©ãƒ¼ãŒèµ·ã“ã‚Šã¾ã™ã€‚
ã—ã‹ã—`user.name`ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ã‚ˆã†ã¨ã™ã‚‹ã¨ã€`æ¬¡éƒ`ã¨æ¨è«–ã•ã‚Œã‚‹ã®ã§ã™ã€‚
ã¤ã¾ã‚Š`name`ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®çµã‚Šè¾¼ã¿ã¯ã§ãã¦ã„ã¦ã‚‚ã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ã§ãã¦ã„ãªã„ã“ã¨ã«ãªã‚Šã¾ã™ã€‚

ã“ã‚Œã¯ãªãœãªã®ã§ã—ã‚‡ã†ã‹ã€‚
`name`ãŒã‚ã‚‹ã“ã¨ã‚‚ã€`æ¬¡éƒ`ã§ã‚ã‚‹ã“ã¨ã‚‚ä¿è¨¼ã—ãŸã¯ãšã§ã™ãƒ»ãƒ»ã€‚

#### TypeScriptã®åˆ¶é™
ç§ãŒæ‰€å±ã™ã‚‹[iCARE](https://www.icare.jpn.com/)ã®ãƒ•ã‚§ãƒ­ãƒ¼ã€[@ozu_syo](https://twitter.com/ozu_syo)ã•ã‚“ã«ä¼ºã£ãŸã¨ã“ã‚ã€ŒTypeScriptãŒå‡¦ç†ã«åˆ¶é™ã‚’ã‹ã‘ã¦ã„ã‚‹ã®ã§ã¯ãªã„ã‹ã€ã¨ã®ã“ã¨ã€‚
ãã‚Œã‚’ãã£ã‹ã‘ã«TypeScriptã®issueã‚’æ¼ã‚‹ã¨æ¬¡ã®ã‚ˆã†ãªissueã¨ã‚³ãƒ¡ãƒ³ãƒˆã‚’è¦‹ã¤ã‘ã¾ã—ãŸã€‚
https://github.com/microsoft/TypeScript/issues/31404#issuecomment-492569479
ä»¥ä¸‹ã¯ã‚³ãƒ¡ãƒ³ãƒˆã®æŠœç²‹ã§ã™ï¼ˆç¿»è¨³: DeepLï¼‰ã€‚
> I think this is a design limitation in discriminant narrowing which is effectively a top-down process, rather than bottom up.
> ã“ã‚Œã¯ã€ãƒœãƒˆãƒ ã‚¢ãƒƒãƒ—ã§ã¯ãªãã€äº‹å®Ÿä¸Šãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã®ãƒ—ãƒ­ã‚»ã‚¹ã§ã‚ã‚‹åˆ¤åˆ¥çµã‚Šè¾¼ã¿ã®è¨­è¨ˆä¸Šã®åˆ¶é™ã ã¨æ€ã„ã¾ã™ã€‚

> the checker will not compose multiple property narrowings when discriminant pruning. So by top-down I mean that it will not collect state from composite narrowings of the same property and use them.
> ãƒã‚§ãƒƒã‚«ã¯åˆ¤åˆ¥ãƒ—ãƒ«ãƒ¼ãƒ‹ãƒ³ã‚°(discriminantã®é¸å®š)æ™‚ã«è¤‡æ•°ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®çµã‚Šè¾¼ã¿ã‚’åˆæˆã—ã¾ã›ã‚“ã€‚ã¤ã¾ã‚Šã€ãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã¨ã„ã†ã®ã¯ã€åŒã˜æ€§è³ªã®è¤‡åˆçš„ãªçµã‚Šè¾¼ã¿ã‹ã‚‰çŠ¶æ…‹ã‚’åé›†ã—ã¦ä½¿ç”¨ã—ãªã„ã¨ã„ã†ã“ã¨ã§ã™ã€‚

ãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã¨ã„ã†ã®ã¯çµã‚Šè¾¼ã¿ã®æ–¹æ³•ã ã¨æ€ã„ã¾ã™ã€‚
ã“ã“ã§ã„ã†`!==`ã‚’åˆ©ç”¨ã—ãŸæ¶ˆå»æ³•ã¯ãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã¨è¨€ãˆã‚‹ã§ã—ã‚‡ã†ã€‚
ãã—ã¦ã€Œè¤‡æ•°ã®ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®çµã‚Šè¾¼ã¿ã‚’ã—ãªã„ã€ã€ã¤ã¾ã‚Š`user.name`ã®å‹ã®ã¿çµã‚Šè¾¼ã‚“ã§ã„ã‚‹ã¨ã„ã†ã“ã¨ã«ãªã‚Šã¾ã™ã€‚
ã‚ˆã£ã¦ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒAã‹Bã‹ã‚’åˆ¤åˆ¥ã§ããªã„ã“ã¨ã‚‚ç´å¾—ã§ãã¾ã™ã€‚

2ã¤ã®æ¡ä»¶å¼ã‚’åˆæˆã™ã‚Œã°ã‚‚ã¡ã‚ã‚“åˆ¤åˆ¥ã¯ã¤ãã‚‚ã®ã®ã€
ãƒˆãƒƒãƒ—ãƒ€ã‚¦ãƒ³ã«ã®è¨ˆç®—ã¯ã‹ãªã‚Šè² è·ãŒã‹ã‹ã‚Šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãŒå¤§å¹…ã«ä¸‹ãŒã£ã¦ã—ã¾ã†ãŸã‚ã€TypeScriptå´ã§æ„å›³çš„ã«åˆ¶é™ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã™ã€‚

#### inã‚’ä½¿ã†
å®Ÿéš›ã«é–‹ç™ºã™ã‚‹å ´åˆã€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‚’çµã‚Šè¾¼ã¿ãŸã„ã¨ãã¯ã‚ã‚‹ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«ã‚¢ã‚¯ã‚»ã‚¹ã—ãŸã„ã‚±ãƒ¼ã‚¹ãŒã»ã¨ã‚“ã©ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
ãã‚“ãªã¨ãã¯`in`ã‚’åˆ©ç”¨ã—ã¦ã€ãƒªãƒ†ãƒ©ãƒ«ã§ã¯ãªããƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã§narowwingã—ã¦ã‚ã’ã‚‹ã¨è‰¯ã„ã§ã—ã‚‡ã†ã€‚

```ts
const func = (user: User) => {
  if ('gender' in user) {
    return user.gender
  }
  return user.age
}
```

# ã‚ã¨ãŒã
ã€Œã‚ã‚Œãƒ¼ã€çµã‚Šè¾¼ã‚ã¦ãã†ãªã‚“ã ã‘ã©ãªãƒ¼ã€ã¨ã„ã†å ´é¢ã¯æ„å¤–ã¨å¤šã„ã®ã§ã¯ãªã„ã§ã—ã‚‡ã†ã‹ã€‚
ãã‚“ãªæ–¹ã®æ•‘ã„ã«å°‘ã—ã§ã‚‚ãªã‚Œã‚Œã°å¹¸ã„ã§ã™ã€‚
ã¾ãŸã€Œã‚ªãƒ—ã‚·ãƒ§ãƒŠãƒ«ã¨ãƒãƒƒãƒˆã‚¤ã‚³ãƒ¼ãƒ«ã€ã®ä»¶ã§ã¯[@ozu_syo](https://twitter.com/ozu_syo)ã•ã‚“ã«å¤šãã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹ã‚’ã„ãŸã ãã¾ã—ãŸã€‚
ã“ã®å ´ã‚’å€Ÿã‚Šã¦æ„Ÿè¬ç”³ã—ä¸Šã’ã¾ã™ã€‚

# å‚è€ƒ
https://www.typescriptlang.org/docs/handbook/2/narrowing.html
https://typescript-jp.gitbook.io/deep-dive/type-system/discriminated-unions
https://zenn.dev/estra/articles/typescript-narrowing
https://zenn.dev/estra/articles/typescript-narrowing-patterns
https://github.com/microsoft/TypeScript/issues/31404
https://github.com/microsoft/TypeScript/issues/49933
